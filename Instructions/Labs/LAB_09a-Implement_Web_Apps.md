---
lab:
    title: '09a - Web アプリの実装'
     module: 'モジュール 09 - サーバーレス コンピューティング'
---

# ラボ 09a - Web Apps の実装
# 受講者用ラボ マニュアル

## ラボ シナリオ

現在、社内のオンプレミス データセンターでホストされている Contoso 社の Web サイトをホストするための Azure Web アプリの使用を評価する必要があります。Web サイトは、PHP ランタイム スタックを使用して Windows サーバー上で実行されています。また、Azure Web アプリのデプロイ スロットを活用して DevOps プラクティスを実装する方法を決定する必要もあります。

## 目標

このラボでは、次の内容を学習します。
  
+ タスク 1: Azure Web アプリを作成する
+ タスク 2: ステージング デプロイ スロットを作成する
+ タスク 3: Web アプリのデプロイ設定を構成する
+ タスク 4: ステージング デプロイ スロットにコードをデプロイする
+ タスク 5: ステージング スロットをスワップする
+ タスク 6: Azure Web アプリの自動スケールリングを構成しテストする
  
## 指示

### 演習 1

#### タスク 1: Azure Web アプリを作成する

このタスクでは、Azure Web アプリを作成します。 

1. [**Azure portal**](http://portal.azure.com) にログインします。

1. Azure portal で、「**アプリ サービス**」を検索して選択し、[**アプリ サービス**]  ブレードで [**+ 追加**] をクリックします。     

1. [**Web アプリ**] ブレードの [**基本**] タブで 、次の設定を指定します (その他は既定値のままにします)。   

    | 設定 | 値 |
    | --- | ---|
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az104-09a-rg1** の名前 |
    | Web アプリの名前 | グローバルに一意な任意の名前 |
    | 発行 | **コード** |
    | ランタイム スタック | **PHP 7.3** |
    | オペレーティング システム | **Windows** |
    | リージョン | Azure Web Apps をプロビジョニングできる Azure リージョンの名前 |
    | App Service プラン | デフォルトの構成を受け入れる |

1. [**次へ**] をクリックします[**監視 >**] の [**Web アプリ**] ブレードの [**監視**] タブで、[**アプリケーション インサイトの有効化**] スイッチを [**いいえ**] に設定し、[**確認と作成**] をクリックして、[**作成**] をクリックします。 

    >**注**: 通常は、**Application Insights** を有効にしますが、このラボではその機能を使用しません。

    >**注**: 次のタスクに進む前に、Web アプリが作成されるまで待ちます。これには約 1 分かかります。 

1. デプロイ ブレードで、[**Go to resource**] (リソースに移動) をクリックします。

#### タスク 2: ステージング デプロイ スロットを作成する

このタスクでは、ステージング デプロイ スロットを作成します。 

1. 新しくデプロイした Web アプリのブレードで、[**URL**] リンクをクリックして、新しいブラウザー タブに既定の Web ページを表示します。

1. 新しいブラウザー タブを閉じ、Azure portal の Web アプリ ブレードの [**デプロイ**] セクションで、[**デプロイ スロット**] をクリックします。 

    >**注**: この時点で、Web アプリには **PRODUCTION** というラベルが付いた単一のデプロイ スロット があります。  

1. [**+ スロットの追加**] をクリックし、次の設定で新しいスロットを追加します。 

    | 設定 | 値 |
    | --- | ---|
    | 名前 | **ステージング** |
    | から設定をクローンする | **設定をクローンしないでください**|

1. Web アプリの [**デプロイ スロット**] ブレードに戻り、新しく作成されたステージング スロットを表すエントリをクリックします。 

    >**注**: これにより、ステージング スロットのプロパティを表示するブレードが開きます。 

1. ステージング スロット ブレードを確認し、その URL が運用スロットに割り当てられているものと異なることを確認します。

#### タスク 3: Web アプリのデプロイ設定を構成する

このタスクでは、Web アプリのデプロイ設定を構成します。 

1. ステージング デプロイ スロット ブレードの [**デプロイ**] セクションで、[**デプロイ センター**] をクリックします。

    >**注意:** ステージング スロット ブレード (運用スロットではなく) にいることを確認します。

1. [**継続的なデプロイ (CI/CD)**] セクションで、[**ローカル Git**] を選択し、[**続行**] をクリックします。

1. [**App Service ビルド サービス**] を選択し、[**続行**] をクリックしてから、[**終了**] をクリックします。 

1. 結果として得られた **Git クローン URL**をメモ帳にコピーします。 

    >**注意:** このラボの次のタスクでは、Git クローン URL の値が必要になります。

1. [**デプロイ認証情報**] ツール バー アイコンをクリックして、[**デプロイ認証情報**] ペインを表示します。    

1. **[ユーザー認証情報]** をクリックします。

1. 必要な情報を入力し、**[資格情報の保存]** をクリックします。  

    | 設定 | 値 |
    | --- | ---|
    | ユーザー名 | 一意な名前 |
    | パスワード | **Pa55w0rd1234** |

    >**注意:** このラボの次のタスクではは、これらの認証情報が必要になります。

#### タスク 4: ステージング デプロイ スロットにコードをデプロイする

このタスクでは、ステージング デプロイ スロットにコードをデプロイします。

1. Azure portal で右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** のいずれかを選択するように求められた場合、**PowerShell**を選択します。 

    >**注**: **Cloud Shell** を初めて起動し、「 **ストレージがマウントされていません**」というメッセージが表示されたら、このラボで使用しているサブスクリプションを選択し、[**ストレージの作成**] をクリックします。 

1. [Cloud Shell] ペインで次を実行し、Web アプリのコードを含むリモート リポジトリを複製します。

   ```pwsh
   git clone https://github.com/Azure-Samples/php-docs-hello-world
   ```
 
1. [Cloud Shell] ウィンドウで次を実行し、現在の場所を、サンプル Web アプリ コードを含むローカル リポジトリの新しく作成されたクローンに設定します。

   ```
   Set-Location -Path $HOME/php-docs-hello-world/
   ```

1. [Cloud Shell] ウィンドウから、次の手順を実行してリモート git を追加します (`[deployment_user_name]` と `[git_clone_url]` のプレースホルダをそれぞれ、前のタスクで指定した**デプロイ資格情報**ユーザー名と **Git Clone Url** の値に置き換えてください)。

   ```
   git remote add [deployment_user_name] [git_clone_url]
   ```

    >**注**: `git remote add` の後の値は、**デプロイ資格情報**のユーザー名と一致する必要はありませんが、一意である必要があります

1. [Cloud Shell] ウィンドウから、次の手順を実行して、サンプル Web アプリ コードをローカル リポジトリから Azure Web アプリのステージングデプロイ スロットにプッシュします (`[deployment_user_name]` プレースホルダーを、前のタスクで識別した「**デプロイ資格情報**ユーザー名」の値に置き換えてください)。
   ```
   git push [deployment_user_name] master
   ```

1. 認証を求められた場合は、`[deployment_user_name]` および対応するパスワード (**Pa55w0rd1234**) を入力します。

1. Cloud Shell ウィンドウを閉じます。

1. ステージング スロット ブレードで、 **[概要]** をクリックし、**[URL]** リンクをクリックして、新しいブラウザー タブに既定の Web ページを表示します。   

1. ブラウザ ページに **Hello World!** メッセージが表示されていることを確認し、新しいタブを閉じます。 

#### タスク 5: ステージング スロットをスワップする

このタスクでは、ステージング スロットを運用スロットとスワップします。

1. Web アプリの運用スロットを表示するブレードに戻ります。

1. **[展開]** セクションで、**[デプロイ スロット]** をクリックし、ツールバー アイコンの **[入れ替え]** をクリックします。     

1. **スワップ** ブレードで、既定の設定値をレビューしてから、**スワップ** をクリックします。 

1. Webアプリの運用スロット ブレードで **[概要]** をクリックし、**[URL]** リンクをクリックして、新しいブラウザー タブに Web サイトのホーム ページを表示します。   

1. デフォルトの Web ページが **HelloWorld!** ページに置き換えられていることを確認します。 

#### タスク 6: Azure Web アプリの自動スケールリングを構成しテストする

このタスクでは、Azure Web アプリの自動スケールを構成してテストします。 

1. Web アプリの運用スロットを表示するブレードの **[設定]** セクションで、**[スケール アウト (App Service プラン)]** をクリックします。   

1. [**カスタム 自動スケーリング**] をクリックします。 

    >**注**: また、Web アプリを手動でスケーリングするオプションもあります。

1. 既定のオプションの **[メトリックに基づくスケール]** を選択したまま、**[+ ルールの追加]** をクリックします

1. **[スケール ルール]** ブレードで、次の設定を指定します (その他は既定値のままにします)。 

    | 設定 | 値 |
    | --- |--- |
    | メトリック ソース | **現在のリソース** |
    | 時間集計 | **Maximum** |
    | メトリック名前空間 | **App Service プランの標準指標** |
    | メトリック名 | **CPU の割合** |
    | 演算子 | **より大きい** |
    | スケール アクションをトリガーするメトリックしきい値 | **10** |
    | 期間 (分単位) | **1** |
    | 時間グレイン統計 | **Maximum** |
    | 操作 | **数量を増やす** |
    | インスタンス数 | **1** |
    | クール ダウン(分単位) | **5** |

    >**注**: これらの値は、待機時間を延長することなく、できるだけ早く自動スケールをトリガーすることを目的としているため、現実的な設定を表すものではありません。 

1. **[追加]** をクリックし、**az10408vmss0 - Scaling**ブレードに戻って、次の設定を指定します (その他は既定値のままにします)。   

    | 設定 | 値 |
    | --- |--- |
    | インスタンスの制限 最小 | **1** |
    | インスタンスの制限の最大値 | **2** |
    | インスタンスの制限 デフォルト | **1** |

1. [**保存**] をクリックします。

1. Azure portal で右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** のいずれかを選択するように求められた場合、**PowerShell**を選択します。 

1. Cloud Shell ウィンドウから、次の操作を実行して、Azure Web アプリの URL アドレスを識別します。

   ```pwsh
   $rgName = 'az104-09a-rg1'

   $webapp = Get-AzWebApp -ResourceGroupName $rgName
   ```

1. [Cloud Shell] ウィンドウから、次の操作を実行して、HTTP 要求を Web アプリに送信するループを開始し、無限ループを実行します。

   ```pwsh
   while ($true) { Invoke-WebRequest -Uri $webapp.DefaultHostName }
   ```

1. [Cloud Shell] ウィンドウを最小化し (閉じないでください)、Web アプリ ブレードの **[監視]** セクションで **[プロセス エクスプローラー]** をクリックします。   

    >**注**: プロセス エクスプローラは、インスタンス数とそのリソース使用率を監視しやすくします。 

1. 数分間、使用率とインスタンス数を監視します。

    >**注**: ページを**更新**する必要があるかもしれません。

1. インスタンスの数が 2 に増えた場合は、[Cloud Shell] ウィンドウを再度開き、**Ctrl + C** キーを押してスクリプトを終了します。 

1. Cloud Shell ウィンドウを閉じます。

#### リソースのクリーンアップ

   >**注**: 新しく作成された Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。

1. Azure portalの [**Cloud Shell**] ウインドウで、[**PowerShell**] セッションを開始します。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成されたすべてのリソース グループを一覧表示します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-09a*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループを削除します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-09a*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**: コマンドは非同期に実行されるため (-AsJob パラメーターによって決まります)、同じ PowerShell セッション内ですぐに別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは次の内容を学習しました。

- Azure Web アプリの作成
- ステージング デプロイ スロットの作成
- 構成済みの Web アプリのデプロイ設定
- ステージング デプロイ スロットにデプロイされたコード
- ステージング スロットのスワップ
- Azure Web アプリの自動スケールの構成とテスト
