---
lab:
    title: '07 - Azure Storage の管理'
    module: 'モジュール 07 - Azure Storage'
---

# ラボ 7 - Azure Storage の管理
# 学生用ラボ マニュアル

## ラボ シナリオ

現在オンプレミスのデータ ストアに存在するファイルを格納するために、Azure Storage の使用を検討する必要があります。これらのファイルの大部分は頻繁にアクセスされませんが、いくつかの例外があります。アクセス頻度の低いファイルを低価格のストレージ層に配置することで、ストレージのコストを最小限に抑える場合。ネットワーク アクセス、認証、認可、レプリケーションなど、Azure Storage が提供するさまざまな保護メカニズムについても検討する予定です。最後に、Azure Files サービスがオンプレミスのファイル共有をホストするのにどの程度適しているかを判断する必要があります。

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## 目標

このラボでは次の内容を学習します。

+ タスク 1: ラボ環境をプロビジョニングする
+ タスク 2: Azure Storage アカウントを作成し、構成する 
+ タスク 3: Blob Storage を管理する
+ タスク 4: Azure Storage の認証と許可を管理する
+ タスク 5: Azure Files 共有を作成して構成する
+ タスク 6: Azure Storage のネットワーク アクセスを管理する

## 予想時間: 40 分

## アーキテクチャの図

![image](../media/lab07.png)

## 手順

### 演習 1

#### タスク 1: ラボ環境をプロビジョニングする

このタスクでは、この課題の後半で使用する Azure 仮想マシンをデプロイします。

1. [Azure portal](https://portal.azure.com) にサインインします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。

    >**注**: **Cloud Shell** の初回起動時に **「ストレージがマウントされていません」** というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、**「ストレージの作成」** を選択します。

1. Cloud Shell ウィンドウのツールバーで、**「ファイルのアップロード/ダウンロード」** アイコンをクリックし、ドロップダウン メニューで **「アップロード」** を選択して、ファイル **\\Allfiles\\Labs\\07\\az104-07-vm-template.json** および **\\Allfiles\\Labs\\07\\az104-07-vm-parameters.json** を Cloud Shell ホーム ディレクトリにアップロードします。

1. 「Cloud Shell」 ウィンドウから次のコマンドを実行して、仮想マシンをホストするリソース グループを作成します。

    >**注**: Azure リージョンの名前を一覧表示するには、`(Get-AzLocation).Location` を実行します

   ```powershell
   $location = 'eastus'

   $rgName = 'az104-07-rg0'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 「Cloud Shell」 ペインから次のコマンドを実行し、アップロードされたテンプレートとパラメーター ファイルを使用して、仮想マシンをデプロイします。

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-07-vm-template.json `
      -TemplateParameterFile $HOME/az104-07-vm-parameters.json `
      -AsJob
   ```

    >**注**: デプロイが完了するのを待たずに、次のタスクに進みます。

1. 「Cloud Shell」 ウィンドウを閉じます。

#### タスク 2: Azure Storage アカウントを作成し、構成する

このタスクでは、Azure Storage アカウントを作成して構成します。

1. Azure portal で、**「ストレージ アカウント」** を検索して選択し、**「+ 作成」** をクリックします。

1. **「ストレージ アカウントの作成する」** ブレードの **「基本」** タブで、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **新しい**リソース グループ **az104-07-rg1** の名前 |
    | ストレージ アカウント名 | 文字と数字で構成される、長さが 3 ~ 24 のグローバルに一意の名前 |
    | 地域 | （US）米国東部  |
    | パフォーマンス | **Standard** |
    | 冗長性 | **geo 冗長ストレージ (GRS)** |

1. **「次へ: 詳細設定 >」** をクリックし、**「詳細設定」** タブで、利用可能なオプションを確認し、既定のオプションのまま **「次へ: ネットワーク >」** をクリックします。

1. **「ストレージ アカウントを作成する」** ブレードの **「ネットワーク」** タブで　**「パブリック エンドポイント (すべてのネットワーク)」** が選択されていることを確認して、**「次へ: データデータ保護 >」** をクリックします。

1. **「ストレージ アカウントの作成する」** ブレードの **「データ保護」** タブで、利用可能なオプションを確認し、既定値を受け入れ、 **「確認および作成」** をクリックし、検証プロセスが完了するのを待ってから、**「作成」** をクリックします。

    >**注**: ストレージ アカウントが作成されるのを待ちます。これにはおよそ 2 分かかります。

1. 「デプロイ」 ブレードで、**「リソースに移動」** をクリックして、「Azure ストレージ アカウント」 ブレードを表示します。

1. 「ストレージ アカウント」 ブレードの **「データ管理」** セクションで、**「geo レプリケーション」** をクリックし、セカンダリの場所をメモします。**「ストレージ エンドポイント」** ラベルの下の **「すべての表示」** リンクをクリックし、**「ストレージ アカウントのエンドポイント」** ブレードを確認します。  

    > **注**: 予想どおり、**「ストレージ アカウントのエンドポイント」** ブレードに、プライマリ エンドポイントとセカンダリ エンドポイントの両方が含まれています。

1. 「ストレージ アカウント」 ブレードの **「設定」** セクションで、**「構成」** をクリックし、**「レプリケーション」** ドロップダウン リストで **「ローカル冗長ストレージ (LRS)」** を選択し、変更を保存します。

1. **「geo レプリケーション」** ブレードに戻り、この時点では、ストレージ アカウントにプライマリの場所だけがあることに注意してください。

1. ストレージ アカウントの **「構成」** ブレードをもう一度表示し、**BLOB のアクセス レベル (既定)** を**クール**に設定し、「**保存**」をクリックします。

    > **注**: クール アクセス層は、頻繁にアクセスされないデータに適しています。

#### タスク 3: Blob Storage を管理する

このタスクでは、BLOB コンテナーを作成し、そのコンテナーに BLOB をアップロードします。

1. 「ストレージ アカウント」 ブレードの **「データ ストレージ」** セクションで、**「コンテナー」** をクリックします。

1. **「+ コンテナー」** をクリックして、次の設定を使用してコンテナーを作成します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-07-container**  |
    | パブリック アクセス レベル | **プライベート (匿名アクセスはありません)** |

1. コンテナーのリストで **「az104-07-container」** をクリックし、**「アップロード」** をクリックします。

1. ラボ コンピュータで **\\Allfiles\\Labs\\07\\LICENSE** を参照し、**「開く」** をクリックしてから、**「アップロード」** をクリックします。

1. **「Files」** をクリックします。**\\Allfiles\\Labs\\07\\LICENSE** を選択します。

1. **「BLOB の アップロード」** ブレードで、**「詳細設定」** セクションを展開し、次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 認証の種類 | **アカウント キー**  |
    | BLOBの種類 | **ブロック BLOB** |
    | ブロック サイズ | **4 MB** |
    | アクセス層 | **ホット** |
    | アップロード先のフォルダー | **LICENSE** |

    > **注**: アクセス階層は、個々の BLOB に対して設定できます。

1. **「アップロード」** をクリックします。

    > **注**: アップロードによって、**LICENSE** という名前のサブフォルダーが自動的に作成されます。

1. **「az104-07-container」** ブレードに戻って **「LICENSE」** をクリックし、**「LICENSE」** ファイルをクリックします。

1. **「LICENSE/LICENSE」** ブレードで、使用可能なオプションを確認します。

    > **注**: BLOB をダウンロードし、アクセス層を変更し (現在、**ホット** に設定されています)、リースを取得するオプションがあります。これにより、リース ステータスが**ロック** (現在は **ロック解除 ** に設定されています) に変更され、BLOB が変更または削除されないように保護され、カスタム メタデータが割り当てられます (任意のキーと値のペアを指定することにより)。また、ファイルを最初にダウンロードすることなく、Azure portal インターフェイス内で直接ファイルを**編集**することもできます。スナップショットを作成したり、SAS トークンを生成することもできます (このオプションは次のタスクで確認します)。v

#### タスク 4: Azure Storage の認証と許可を管理する

このタスクでは、Azure Storage の認証と認可を構成します。

1. **「LICENSE/LICENSE」** ブレードの **「概要」** タブで、**「URL」** エントリの横にある **「クリップボードにコピー」** ボタンをクリックします。

1. InPrivate モードを使用して別のブラウザー ウィンドウを開いて、前の手順でコピーした URL に移動します。

1. **ResourceNotFound** または **PublicAccessNotPermitted** という XML 形式のメッセージが表示されます。

    > **注**: これは正常な動作であり、作成したコンテナーのパブリック アクセス レベルが **「プライベート (匿名アクセスはありません)」** に設定されているためです。

1. InPrivate モードのブラウザー ウィンドウを閉じて、Azure Storage コンテナーの **「LICENSE/LICENSE」** ブレードが表示されているブラウザー ウィンドウ に戻り、**「SAS の生成」** タブに切り替えます。

1. **「ライセンス/LICENSE」** ブレードの **「SAS の生成」** タブで、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 署名キー | **キー 1** |
    | アクセス許可 | **読み取り** |
    | 開始日 | 昨日の日付 |
    | 開始時刻 | 現在の時刻 |
    | 有効期限 | 明日の日付 |
    | 有効期限 | 現在の時刻 |
    | 使用できる IP アドレス | 空白のままにする |
    

1. **「SAS トークンおよび URL を生成」** をクリックします。

1. **「BLOB SAS URL」** エントリの横にある **「クリップボードにコピー」** ボタンをクリックします。

1. InPrivate モードを使用して別のブラウザー ウィンドウを開いて、前の手順でコピーした URL に移動します。

    > **注**: Microsoft Edge を使用している場合は、**MIT ライセンス (MIT)** ページが表示されます。Chrome、Microsoft Edge (Chromium) または Firefox を使用している場合は、ファイルをダウンロードしてメモ帳で開くと、ファイルの内容を表示できるはずです。

    > **注**: 新しく生成された SAS トークンに基づいてアクセスが承認されるため、これは正常な動作です。

    > **注**: BLOB SAS URL を保存します。これは、このラボで後ほど必要になります。

1. InPrivate モードのブラウザー ウィンドウを閉じ、Azure Storage コンテナーの **「LICENSE/LICENSE」** ブレードが表示されているブラウザー ウィンドウに戻り、そこから **「az104-07- コンテナー」** の「**概要**」ブレードに戻ります。

1. **「認証方法」** ラベルの横にある **「Azure AD のユーザー アカウントに切り替える」** リンクをクリックします。

    > **注**: 認証方法を変更するとエラーが表示されます（エラーは「Azure AD でユーザーアカウントを使用してデータをリスト化する権限がありません。」）。これは想定されているものです。  

    > **注**: この時点では、認証方法を変更する権限がありません。

1. **「az104-07- コンテナー」** ブレードで、**「アクセス制御 (IAM)」** をクリックします。

1. **「ロールの割り当て」**タブに切り替えて、**「追加」** の **「ロールの割り当てを追加」** をクリックします。

1. **「ロールの割り当ての追加」** ブレードで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | 役割 | **ストレージ BLOB データ所有者** |
    | アクセスの割り当て | **ユーザー、グループ、またはサービス プリンシパル** |
    | 選択 | ユーザー アカウントの名前 |

1. **「保存」** をクリックして、**「az104-07- コンテナー」** コンテナーの **「概要」** ブレードに戻り、コンテナーに再度アクセスできることを確認します。

    > **注**: この変更が有効になるまで、最大 5 分かかる場合があります。

#### タスク 5: Azure Files 共有を作成し、構成する

このタスクでは、Azure Files 共有を作成して構成します。

    > **注**: このタスクを開始する前に、このラボの最初のタスクでプロビジョニングした仮想マシンが実行されていることを確認します。

1. Azure portal で、このラボの最初のタスクで作成したストレージ アカウントのブレードに戻り、**「データストレージ」** セクションの **「ファイル共有」** をクリックします。

1. **「+ ファイル共有」** をクリックし、次の設定でファイル共有を作成します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-07-share** |
    | レベル | **ホット** |

1. 新しく作成したファイル共有をクリックします。

1. 「**接続**」をクリックし、「**Windows**」 タブが選択されていることを確認します。以下に、スクリプトを含む灰色のテキスト ボックスがあります。そのボックスの右下隅にあるページ アイコンにカーソルを合わせ、**「クリップボードにコピー」** をクリックします。 

1. Azure portal で **「Virtual Machines」** を検索して選択し、仮想マシンのリストで **「az104-07-vm0」** をクリックします。

1. **「az104-07-vm0」** ブレードの **「操作」** セクションで、**「実行コマンド」** をクリックします。

1. **「az104-07-vm0 \| 実行コマンド」** ブレードで、**「RunPowerShellScript」** をクリックします。

1. **「コマンドスクリプトの実行」** ブレードで、このタスクの前半でコピーしたスクリプトを **「PowerShell スクリプト」** ウィンドウに貼り付け、**「実行」** をクリックします。

1. スクリプトが正常に完了したことを確認します。

1. **「PowerShell スクリプト」** ウィンドウの内容を次のスクリプトに置き換え、**「実行」** をクリックします。

   ```powershell
   New-Item -Type Directory -Path 'Z:\az104-07-folder'

   New-Item -Type File -Path 'Z:\az104-07-folder\az-104-07-file.txt'
   ```

1. スクリプトが正常に完了したことを確認します。

1. **「az104-07-share** ファイル共有」 ブレードに戻り、**「更新」** をクリックして、フォルダーのリストに **「az104-07-folder」** があることを確認します。

1. **「az104-07-folder」** をクリックし、ファイルのリストに **「az104-07-file.txt」** があることを確認します。

#### タスク 6: Azure Storage のネットワーク アクセスを管理する

このタスクでは、Azure Storage のネットワーク アクセスを構成します。

1. Azure portal で、このラボの最初のタスクで作成したストレージ アカウントのブレードに戻り、**「セキュリティとネットワーク」** セクションで、**「ネットワーク」** をクリックしてから、**「ファイアウォールとバーチャル ネットワーク」** タブをクリックします。

1. **「許可するアクセス元」** セクションの **「選択されたネットワーク」** オプションをクリックして、このオプションを有効にしたら使用できる構成設定を確認します。

    > **注**: これらを設定すると、仮想ネットワークの指定サブネット上の Azure 仮想マシンと、ストレージ アカウントとの直接接続をサービス エンドポイントを使用して構成できます。

1. **「クライアント IP アドレスの追加」** チェック ボックスをクリックして、**「保存」** をクリックします。

1. InPrivate モードを使用して別のブラウザー ウィンドウを開き、前のタスクで生成した BLOB SAS URL に移動します。

1. **「MIT ライセンス (MIT)」** ページの内容が表示されます。

    > **注**: これは正常な動作であり、クライアント IP アドレスから接続しているためです。

1. InPrivate モードのブラウザー ウィンドウを閉じ、Azure Storage コンテナーの **「ライセンス/LICENSE」** ブレードが表示されているブラウザー ウィンドウに戻り、Azure Cloud Shell ウィンドウを開きます。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。

1. Cloud Shell ウィンドウから以下を実行して、ストレージアカウントの **az104-07-container** コンテナーから LICENSE BLOB のダウンロードを試みます (`[blob SAS URL]` プレースホルダーを前のタスクで生成した BLOB SAS URL に置き換えます)。

   ```powershell
   Invoke-WebRequest -URI '[blob SAS URL]'
   ```
1. ダウンロードの試行が失敗したことを確認します。

    > **注**: **AuthorizationFailure** を示すメッセージが表示されます。**この要求には、この操作を実行する権限がありません**。Cloud Shell インスタンスをホストする Azure VM に割り当てられた IP アドレスから接続しているため、これは正常な動作です。

1. 「Cloud Shell」 ペインを閉じます。

#### リソースをクリーン アップする

   >**注**: 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

1. Azure portal の **「Cloud Shell」** ウィンドウで **「PowerShell」** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-07*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-07*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**: コマンドは非同期で実行されるので (-AsJob パラメーターによって決定されます)、別の PowerShell コマンドを同一 PowerShell セッション内ですぐに実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは次の内容を学習しました。

- ラボ環境をプロビジョニングしました
- Azure Storage アカウントを作成して構成しました
- BLOB ストレージを管理しました
- Azure Storage の認証と認可を管理しました
- Azure Files 共有を作成および構成しました
- Azure Storage のネットワーク アクセスを管理しました
