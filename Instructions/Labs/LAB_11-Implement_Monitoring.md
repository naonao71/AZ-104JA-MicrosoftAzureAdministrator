---
lab:
    title: '11 - モニタリングを実装する'
    module: 'モジュール 11 - モニタリング'
---

# 課題 11 - モニタリングを実装する
# 受講生用ラボ マニュアル

## ラボ シナリオ

Azure リソースのパフォーマンスと構成に関する分析情報を提供する Azure の機能を、特に Azure Virtual Machines に焦点を当てて評価します。これを実現するために、ログ分析を含む Azure Monitor の機能を調べます。 

## Objectives

このラボでは次の内容を学習しました。

+ Task 1: ラボ環境をプロビジョニングします。
+ タスク 2: Azure Log Analytics ワークスペースと Azure 自動化ベースのソリューションを作成して構成します。
+ タスク 3: Azure 仮想マシンの既定の監視設定をレビューします。
+ タスク 4: Azure 仮想マシンの診断設定を構成します
+ タスク 5: Azure Monitor の機能をレビューします
+ タスク 6: Azure ログ分析機能をレビューします

## 予想時間: 45 分

## 指示

### 演習 1

#### タスク 1: ラボ環境をプロビジョニングします。

このタスクでは、監視シナリオのテストに使用する仮想マシンを展開します。

1. [Azure Portal](https://portal.azure.com) にサインインします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。 

    >**注**: **Cloud Shell** の初回起動時に「**ストレージがマウントされていません**」というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、「**ストレージの作成**」 を選択します。 

1. Cloud Shell ウィンドウのツールバーで、**「ファイルのアップロード/ダウンロード」** アイコンをクリックし、ドロップダウン メニューで **「アップロード」** を選択して、ファイル **\\Allfiles\\Labs\\11\\az104-11-vm-template.json** および **\\Allfiles\\Labs\\11\\az104-11-vm-parameters.json** を Cloud Shell ホーム ディレクトリにアップロードします。

1. Cloud Shell ウィンドウから次のコマンドを実行して、仮想マシンをホストするリソース グループを作成します (`[Azure_region]` プレースホルダーを、Azure 仮想マシンをデプロイする Azure リージョンの名前に置き換えます)。

    >**注**: **ワークスペース マッピングのドキュメント**で参照されている [Log Analytics ワークスペースリージョン](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)としてリストされているリージョンのいずれかを選択してください

   ```pwsh
   $location = '[Azure_region]'

   $rgName = 'az104-11-rg0'

   New-AzResourceGroup -Name $rgName -Location $location
   ```

1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して最初の仮想ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して仮想マシンをデプロイします。

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-11-vm-template.json `
      -TemplateParameterFile $HOME/az104-11-vm-parameters.json `
      -AsJob
   ```

    >**注**: デプロイが完了するのを待たず、代わりに次のタスクに進みます。デプロイメント過程は約 3 分間かかる場合があります。
    
#### タスク 2: Microsoft.Insights および Microsoft.AlertsManagement リソース プロバイダーを登録します。

1. 「Cloud Shell」 ペインから、次のコマンドを実行して、Microsoft.Insights および Microsoft.AlertsManagement リソース プロバイダーを登録します。

   ```pwsh
   Register-AzResourceProvider -ProviderNamespace Microsoft.Insights
   
   Register-AzResourceProvider -ProviderNamespace Microsoft.AlertsManagement
   ```

1. 「Cloud Shell」 ウィンドウを最小化します (ただし、閉じないでください)。

#### タスク 3: Azure Log Analytics ワークスペースと Azure 自動化ベースのソリューションを作成して構成します。

このタスクでは、Azure Log Analytics ワークスペースと Azure 自動化ベースのソリューションを作成して構成します。

1. Azure portal で、「**Log Analytics ワークスペース**」を検索して選択し、「**Log Analytics ワークスペース**」 ブレードで 「**+ 追加**」 を選択します。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**基本**」 タブで、次の設定を行い、「**Review + Create**」 をクリックし、「**作成**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボのために使用する Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az104-11-rg1** の名前 |
    | Log Analytics ワークスペース | 一意な名前 |    
    | リージョン | 前のタスクで仮想マシンをデプロイした Azure リージョンの名前 |

    >**注**: 前のタスクで仮想マシンをデプロイしたリージョンと同じリージョンを指定してください。

    >**注**: デプロイが完了するのを待ちます。デプロイメント過程は約 1 分間かかる場合があります。

1. Azure portalで、「**Automation アカウント**」 を検索して選択し、「**Automation アカウント**」 ブレードで、「**+ 追加**」 をクリックします。

1. **「Automation アカウントの追加」** ブレードに、次の設定を指定し、**「作成」** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | 一意な名前 |
    | サブスクリプション | このラボのために使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az104-11-rg1** |
    | 場所 |  [ワークスペース マッピングのドキュメント](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)に基づいて決定される Azure リージョンの名前 |
    | Azure Run As アカウントを作成する | **有** |

    >**注**: [ワークスペース マッピングのドキュメント](https://docs.microsoft.com/ja-jp/azure/automation/how-to/region-mappings)に基づいて Azure リージョンを指定していることを確認します。

    >**注**: デプロイが完了するのを待ちます。デプロイには約 3 分間かかります。

1. **「オートメーション アカウントの追加」** ブレードで、**「最新の情報に更新」** をクリックし、新しく作成した Automation アカウントを表すエントリをクリックします。

1. 「Automation アカウント」 ブレードの 「**構成管理**」 セクションで、「**インベントリ**」 をクリックします。

1. **「インベントリ」** ペインの **「Log Analytics ワークスペース」** ドロップダウン リストで、このタスクで前に作成した 「Log Analytics ワークスペース」 を選択し、**「有効」** をクリックします。 

    >**注**: 対応する Log Analytics ソリューションのインストールが完了するまで待ちます。これにはおよそ 3 分かかる場合があります。

    >**注**: これにより、 **Change Tracking** ソリューションも自動的にインストールされます。

1. 「Automation アカウント」 ブレードの **「更新管理」** セクションで、**「更新管理」** をクリックし、**「有効」** をクリックします。

    >**注**: インストールが完了するまで待ちます。これにはおよそ 5 分間かかる場合があります。

#### タスク 4: Azure 仮想マシンの既定の監視設定をレビューします。

このタスクでは、Azure 仮想マシンの既定の監視設定を確認します。

1. Azure portalで、**「Virtual Machines」** を検索して選択し、 **「Virtual Machines」** ブレードで、**「az104-11-vm0」** を選択します 。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**指標**」 をクリックします。

1. **az104-11-vm0** で **| 「指標」** ブレードの既定のグラフでは、使用可能な **指標名前空間**は **仮想マシン ホスト**のみです。

    >**注**: ゲスト レベルの診断設定がまだ構成されていないので、これは予期されます。

1. **「指標」** ドロップダウン リストで、使用可能なメトリックの一覧を確認します。

    >**注**: このリストには、ゲストレベルのメトリックにアクセスしなくても、仮想マシン ホストから収集できる、CPU、ディスク、およびネットワーク関連のメトリックの範囲が含まれています。

1. 「**メトリック**」 ドロップダウン リストで、「**CPU 使用率**」 を選択し、「**集計**」 ドロップダウン リストで 「**平均**」 を選択し、結果のグラフを確認します。        

#### タスク 5: Azure 仮想マシンの診断設定を構成します

このタスクでは、Azure Virtual Machine の診断設定を構成します。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**診断設定**」 をクリックします。

1. **az104-11-vm0** の 「**概要**」 タブ **|** 「**診断の設定**」 ブレードで、「**ゲスト レベルの監視を有効にする**」 をクリックします。  

    >**注**: 操作が有効になるまでお待ちください。これにはおよそ 3 分かかる場合があります。

1. **az104-11-vm0** の 「**パフォーマンス カウンター**」 タブに切り替えます。**|** 「**診断の設定**」 ブレードをクリックし、使用可能なカウンターを確認します。

    >**注**: 既定では、CPU、メモリ、ディスク、およびネットワーク の各カウンターが有効になっています。詳細な一覧については、**カスタム** ビューに切り替えることができます。

1. **az104-11-vm0** の **「ログ」** タブに切り替えます。**| 「診断の設定**」 ブレードをクリックし、使用可能なイベント ログの収集オプションを確認します。

    >**注**: 既定では、ログ収集には、アプリケーション ログおよびシステム ログからの重大、エラー、および警告のエントリと、セキュリティ ログからの監査エラー エントリが含まれます。ここでも、 詳細な構成設定を行うために**カスタム** ビューに切り替えることができます。

1. 「**az104-11-vm0**」 ブレードの 「**監視**」 セクションで、「**ログ**」 をクリックしてから 「**有効化**」 をクリックします。 

1. **「az104-11-vm0 - ログ」** ブレードで、このラボで前に作成した 「Log Analytics ワークスペースの選択」 ドロップダウン リストで **「Log Analytics ワークスペース」 が選択されていること** を確認し、**「有効」** をクリックします。

    >**注**: デプロイが完了するのを待たず、代わりに次の手順に進みます。操作には約 5 分間かかります。

1. **az104-11-vm0** で **| 「ログ」** ブレードの **「監視」** セクションで 、**「指標」** をクリックします。

1. **az104-11-vm0** で **| 「指標」** ブレードの既定のグラフでは、この時点で **「メトリックス の名前空間」** ドロップダウン リストに加えて、**「仮想マシン ホスト」** エントリに **ゲスト (クラシック)** エントリも含まれていることに注意してください。

    >**注**: これは、ゲスト レベルの診断設定を有効にしているためです。

1. **「指標」** ドロップダウン リストで、使用可能なメトリックの一覧を確認します。

    >**注**: このリストには、ホストレベルの監視のみに依存する場合は利用できない追加のゲストレベルのメトリックが含まれています。 

1. **「メトリック」** ドロップダウン リストの、**「集計」** ドロップダウン リストで **「メモリ\使用可能バイト数」** を選択し、**「平均」** を選択して、結果のグラフを確認します。 

#### タスク 6: Azure Monitor の機能をレビューします

1. Azure portal で、**Monitor** を検索して選択し、**Monitor** で ** | 「概要」** ブレードで、**「メトリック」** をクリックします。

1. **「スコープの選択」** ブレードの **「参照」** タブで、**az104-11-rg0** リソース グループに移動し、それを展開して、そのリソース グループ内の **az104-11-vm0** 仮想マシンを選択し、**「適用」** をクリックします。

    >**注**: これにより、**「az104-11-vm0 - メトリック」** ブレードで使用できるビューとオプションと同じオプションが提供されます。

1. 「**メトリック**」 ドロップダウン リストで、「**CPU 使用率**」 を選択し、「**集計**」 ドロップダウン リストで 「**平均**」 を選択し、結果のグラフを確認します。       

1. **「監視」** で ** | 「メトリック」** ブレードで、**「新しいアラート ルール」** をクリックします。

    >**注**: メトリックからのアラート ルールの作成は、ゲスト (クラシック) メトリック名前空間からのメトリックではサポートされていません。これは、 [Windows 仮想マシンのリソース マネージャー テンプレートを使用して Azure Monitor メトリック ストアにゲスト OS メトリックを送信するのドキュメントで説明されているように、Azure Resource Manager テンプレートを使用して実現できます。](https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm)

1. 「**アラート ルールの作成**」 ブレードの 「**条件**」 セクションで、既存の条件をクリックします。    

1. 「**シグナル ロジックの構成**」 ブレードのシグナルの一覧の 「**アラート ロジック**」 セクションで 、次の設定を指定し (他の設定は既定値のままにします)、「**完了**」 をクリックします。     

    | 設定 | 値 |
    | --- | --- |
    | しきい値 | **静的** |
    | 演算子 | **より大きい** |
    | 集計タイプ | **平均** |
    | しきい値 | **2** |
    | 集計の粒度 (期間) | **1 分** |
    | 評価の頻度 | **1 分毎** |

1. **「ルールの作成」** ブレードの **「アクション グループ」** セクションで 、**「アクション グループの選択」** をクリックし、**「+ アクション グループの作成」** ボタンをクリックします。

1. **「アクション グループの追加」** ブレードで、次の設定を指定します (他の設定はデフォルト値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | アクション グループ名:  | **az104-11-ag1** |
    | 短い名前:  | **az104-11-ag1** |
    | サブスクリプション | このラボのために使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az104-11-rg1** |

1. **「アクション グループの追加」** ブレードの、**「アクション」** セクションで次の設定を指定します (他の設定はデフォルト値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | アクション グループ名:  | **az104-11-ag1 email** |
    | アクション タイプ | **メール/SMS/プッシュ/音声** |

1. **「az104-11-ag1 email」** アクション行で、**「詳細を編集」** をクリックします

1. **「電子メール/SMS/プッシュ/音声」** ブレードで、**「電子メール」** チェックボックスをオンにし、**「電子メール」** テキストボックスに自分のメール アドレスを入力し、他のユーザーに既定値を残して **「OK」** をクリックし、**「アクション グループの追加」** ブレードで、**「OK」** をクリックします。

1. **「ルールの作成」** ブレードで、次の設定を指定します (他の設定はデフォルト値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 警告ルール名 | **テストしきい値を超える CPU 割合** |
    | 記述 | **テストしきい値を超える CPU 割合** |
    | 重大度 | **重要度 3** |
    | 作成時にルールを有効にする | **有** |

1. 「**アラート ルールの作成**」 をクリックし、「**ルールの作成**」 ブレードを閉じます。

    >**注**: メトリック アラート ルールがアクティブになるには、最大　10　分間かかる場合があります。

1. Azure portalで、**「Virtual Machines」** を検索して選択し、 **「Virtual Machines」** ブレードで、**「az104-11-vm0」** を選択します 。

1. 「**az104-11-vm0**」 ブレードで、「**接続**」 をクリックし、ドロップダウン メニューで 「**RDP**」 をクリックし、「**RDP を使用して接続する**」 ブレードで 「**RDP ファイルのダウンロード**」 をクリックし、プロンプトに従ってリモート デスクトップ セッションを開始します。         

    >**注**: この手順では、Windows コンピューターからリモート デスクトップ経由で接続することを指します。Mac では、Mac App Store からリモート デスクトップ クライアントを使用でき、Linux コンピューターでは、オープンソースの RDP クライアント ソフトウェアを使用できます。

    >**注**: ターゲット仮想マシンに接続する際は、警告メッセージを無視できます。

1. プロンプトが表示されたら、 **受講生**ユーザー名と **Pa55w.rd1234** パスワードを使用してサインインします。

1. リモート デスクトップ セッション内で、「**スタート**」 をクリックし、「**Windows システム**」 フォルダーを展開して、「**コマンド プロンプト**」 をクリックします。

1. コマンド プロンプトから次のコマンドを実行して、復元する **hosts** ファイルを元の場所にコピーします。 

   ```
   for /l %a in (0,0,1) do echo a
   ```

    >**注**: これにより、新しく作成されたアラート ルールのしきい値を超える CPU 使用率を増加させる無限ループが開始されます。

1. リモート デスクトップ セッションを開いたままにして、ラボ コンピューターに Azure portal を表示するブラウザーの画面に戻ります。

1. Azure portal で、「**監視**」 ブレードに戻り、「**アラート**」 をクリックします。

1. **Sev 3** アラートの数をメモし、**Sev 3** 行をクリックします。 

    >**注**: 数分待ってから 「**更新**」 をクリックする必要がある場合があります。

1. 「**すべてのアラート**」 ブレードで、生成されたアラートを確認します。

#### タスク 7: Azure ログ分析機能をレビューします

1. Azure portal で、「**監視**」 ブレードに戻り、「**ログ**」 をクリックします。 

    >**注**: 初めて Log Analytics にアクセスする場合は、「**開始**」 をクリックする必要がある場合があります。

1. 「**スコープの選択**」 ブレードで、「**az104-11-rg0**」 リソース グループに移動し、それを展開して、「**a104-11-vm0**」 を選択して、「**適用**」 をクリックします。

1. クエリ ウインドウで、次のクエリを貼り付けて、「**実行**」 をクリックします。

   ```
   // 仮想マシンの可用性メモリ
   // 過去 1 時間の VM の使用可能なメモリをグラフ化します。
   InsightsMetrics
   | where TimeGenerated > ago(1h)
   | where Name == "AvailableMB"
   | project TimeGenerated, Name, Val
   | render timechart
   ```

1. ツール バーの **「サンプル クエリの開始」** ペインで **「サンプル クエリの例」** をクリックし、各タブを確認 して 、**「VM の可用性の追跡」** を見つけて、**「実行」** をクリックします。

1. 結果のグラフを確認し、次のテキストを含む行を削除します。

   ```
   | where TimeGenerated > ago(1h)
   ```

    >**注**: その結果、ツールバーの 「**時間範囲**」 のエントリが 「**クエリに設定**」 から 「**過去 24 時間**」 に変更されました。  

1. クエリを再実行し、結果のグラフを確認します。

1. **「新しいクエリ 1」** タブの **「テーブル」** タブで、**仮想マシン** テーブルの一覧を確認します。

1. **「仮想マシン」** セクションのテーブルの一覧。 

    >**注**: いくつかのテーブルの名前は、この実習ラボで先ほどインストールしたソリューションに対応しています。

1. **VMComputer** エントリの上にマウス を移動し、**「データのプレビュー」** アイコンをクリックします。  

1. データが使用可能な場合は、**「更新」** ペインで **「クエリ エディターで参照」** をクリックします。

    >**注**: 更新データが利用可能になるまで、数分待つ必要がある場合があります。

1. ツール バーの **「サンプル クエリの作成」** ペインで **「サンプル クエリの例」** をクリックし、各タブを確認して、**「仮想マシンの空きディスク領域」** を見つけて、**「実行」** をクリックします。

#### リソースをクリーンアップします。

   >**注**: 新規作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

1. Azure portal の **Cloud Shell** ウィンドウで **PowerShell** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-11*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

   ```pwsh
   Get-AzResourceGroup -Name 'az104-11*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**: コマンドは非同期で実行されるので (-AsJob パラメーターによって決定されます)、別の PowerShell コマンドを同一 PowerShell セッション内ですぐに実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは次の内容を学習しました。

- ラボ環境をプロビジョニングする
- Azure Log Analytics ワークスペースと Azure 自動化ベースのソリューションを作成して構成します。
- Azure 仮想マシンの既定の監視設定をレビューします。
- Azure Virtual Machine の診断設定を構成する
- Azure Monitor の機能をレビューする
- Azure Log Analytics の機能をレビューする
